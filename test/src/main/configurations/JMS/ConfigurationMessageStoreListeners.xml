<Module
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="https://schemas.frankframework.org/FrankConfig.xsd">
	<Adapter name="MultipleReceiversAdapter-TestTrigger" active="${active.jms}">
		<Receiver name="testStep1Trigger-Receiver">
			<JavaListener serviceName="testStep1Trigger-Listener" name="step1"/>
		</Receiver>

		<Pipeline>
			<SenderPipe name="Pre-Test IBISSTORE Cleanup">
				<FixedQuerySender
					query="DELETE FROM IBISSTORE WHERE SLOTID = 'multiReceiverTest'"
				/>
			</SenderPipe>
			<SenderPipe name="Send Trigger Message" getInputFromSessionKey="originalMessage">
				<JmsSender
					jmsRealm="qcf"
					destinationName="${jms.destination.i4testiaf_in}">
					<Param name="SOURCE" value="${hostname}_multipleReceiver" />
				</JmsSender>
			</SenderPipe>
		</Pipeline>
	</Adapter>

	<Adapter name="MultipleReceiversAdapter-RetryTrigger" active="${active.jms}">
		<Receiver name="testStep2Trigger-Receiver">
			<JavaListener serviceName="testStep2Trigger-Listener" name="step2"/>
		</Receiver>

		<Pipeline>
			<SenderPipe name="Find Message Key to Retry">
				<FixedQuerySender
					queryType="SELECT"
					query="SELECT MESSAGEKEY FROM IBISSTORE WHERE SLOTID = 'multiReceiverTest'"
					scalar="true"
				/>
			</SenderPipe>
			<SenderPipe name="Trigger Manual Retry">
				<HttpSender
					methodType="POST"
					postType="FORMDATA"
					allowSelfSignedCertificates="true"
					verifyHostname="false"
				>
					<Param name="configuration" value="JMS"/>
					<Param name="adapterName" value="MultipleReceiversAdapter"/>
					<Param name="receiverName" sessionKey="originalMessage" xpathExpression="/receiverNameForRetry/text()"/>
					<Param name="messageIds"/>
					<Param name="url" pattern="${web.protocol}://${web.host}:${web.port}${web.contextpath}/iaf/api/configurations/{configuration}/adapters/{adapterName}/receivers/{receiverName}/stores/Error"/>
				</HttpSender>
			</SenderPipe>
		</Pipeline>
	</Adapter>

	<Adapter name="MultipleReceiversAdapter" description="Used to retry messages using from EsbJmsListener with a MessageStoreListener" active="${active.jms}">
		<Receiver name="jmsReceiver"
			transactionAttribute="Required"
			maxRetries="0"
			onError="RECOVER"
			stopTimeout="600">

			<JmsListener name="esbListener"
				destinationName="${jms.destination.i4testiaf_in}"
				jmsRealm="qcf"
				messageSelector="SOURCE='${hostname}_multipleReceiver'" />

			<JdbcErrorStorage name="errorStorage"
				slotId="multiReceiverTest" />

			<JdbcMessageLog name="messagelog"
				slotId="multiReceiverTest"
				retention="3" />
		</Receiver>

		<Receiver name="retryReceiver"
			transactionAttribute="Required"
			maxRetries="0"
			pollInterval="60">

			<MessageStoreListener name="messageStoreListener"
				datasourceName="${jdbc.datasource.default}"
				slotId="multiReceiverTest"
				statusValueInProcess="P" />
		</Receiver>

		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" />
				<Exit name="ERROR" state="ERROR" />
			</Exits>
			<IfPipe name="Check if pipeline should always fail or only on manual retry"
				xpathExpression="/root = 'fail-always'">
				<Forward name="then" path="ERROR"/>
				<Forward name="else" path="Check If Pipeline Should Fail or Succeed"/>
			</IfPipe>
			<IfPipe name="Check If Pipeline Should Fail or Succeed"
				getInputFromSessionKey="__isManualRetry" expressionValue="true">
				<Forward name="then" path="EXIT"/>
				<Forward name="else" path="ERROR"/>
			</IfPipe>
		</Pipeline>
	</Adapter>
</Module>
